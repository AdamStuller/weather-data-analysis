---
title: "Preprocessing"
output: html_document
---

```{r, include = FALSE}
source('setup.R')
```



```{r NA, echo = FALSE}

NA_values <- c("", '999', '9999', '99999', '999999', '+999', '+9999','+99999', '+999999', '009999')

process_col <- function(val, scaling = 1) {
  if (is.na(as.numeric(val)) || as.numeric(val) %in% NA_values){
    val <- NA
  }
  return (as.numeric(val)/scaling)
} 

```

## Loading of documents (years 1973 - 2020)

```{r setup}
#selected_cols <- c('STATION', 'DATE', 'TMP', 'WND_ANGLE', 'WND_SPEED', 'VIS', 'SLP', 'CIG', 'DEW', 'LATITUDE', 'LONGITUDE', 'ELEVATION','SNOW_DEPTH', 'PWO', 'NAME','GSO')


#allfiles <- list.files(path = "../data", pattern = "*.csv", full.names = T)
#data_sliac <- data.table::rbindlist(lapply(allfiles, function(x) cbind(fread(x, fill = T), gsub(".csv", "", x))), fill = T)
#data_sliac <- as.data.frame(data_sliac)
#View(data_sliac)

selected_cols <- c('STATION', 'DATE', 'TMP', 'WND_ANGLE', 'WND_SPEED', 'VIS', 'SLP', 'CIG', 'DEW','SNOW_DEPTH', 'PWO','GSO')

```

```{r}
read.csv(file= "../data/all_data.csv") %>% 
  dplyr::filter(STATION == 11903099999 | STATION == 11927599999 ) %>%
  dplyr::mutate(
      year = ymd_hms(DATE) %>% 
        lubridate::year() %>% 
        map_chr(~ as.character(.x))
    ) %>%
  dplyr::filter(year >= 1973 & year <2021) %>%
  separate(TMP, c('TMP', NA), sep=',')  %>% 
  separate(WND, c('WND_ANGLE', NA, NA, 'WND_SPEED', NA)) %>%
  separate(VIS, c('VIS', NA, NA, NA)) %>% 
  separate(SLP, c('SLP', NA)) %>% 
  separate(CIG, c('CIG', NA, NA, NA)) %>% 
  separate(DEW, c('DEW', NA), sep=',') %>% 
  separate(AJ1, c('SNOW_DEPTH', NA, NA, NA, NA, NA, NA)) %>%
  separate(AY1, c('PWO', NA, NA, NA)) %>% 
  separate(IA1, c('GSO', NA)) %>%
  dplyr::mutate(
    TMP = map_dbl(.$TMP,  process_col, 10),
    TMP = na_if(TMP, 999.9),
    WND_ANGLE = map_dbl(.$WND_ANGLE, process_col),
    WND_SPEED = map_dbl(.$WND_SPEED, process_col, 10),
    VIS = map_dbl(.$VIS, process_col),
    SLP = map_dbl(.$SLP, process_col, 10),
    CIG = map_dbl(.$CIG, process_col),
    DEW = map_dbl(.$DEW, process_col, 10),
    SNOW_DEPTH = map_dbl(.$SNOW_DEPTH, process_col),
    PWO = dplyr::na_if(PWO, ""),
    GSO = dplyr::na_if(GSO, "")
  ) %>%

  dplyr::select(all_of(selected_cols)) %>% 
  write.csv(file="../data/all.csv")

```

```{r}
all_data <- read.csv(file= "../data/all.csv")
View(all_data)

```


# Kruhovy graf G17

Dufal som ze to bude jednoduche ale exponencialne rozdelenie aj normalne aj to nase mi dava uplne presne kruhy, takze tak bude asi nejaka chyba... pockame, kum to Michal urobi pre erko. 

```{r}
n <- nrow(mandatory_data)
lo <- (n * (n - 1) / 2)^(-1 / 2)

Vx <- lo * cos(pi * mandatory_data$TMP)
Vy <- lo * sin(pi * mandatory_data$TMP)

ggplot(mapping=aes( x=Vx, y=Vy)) +
  geom_point() + 
  coord_fixed()
```
```{r}
normal_dist <- rnorm(-20:40, n = 2000) 

n <- length(normal_dist)
lo <- (n * (n - 1) / 2)^(-1 / 2)

Vx <- lo * cos(pi * normal_dist)
Vy <- lo * sin(pi * normal_dist)

ggplot(mapping=aes( x=Vx, y=Vy)) +
  geom_point() + 
  coord_fixed()

```
```{r}
exp_dist <- rexp(20000)

n <- length(exp_dist)
lo <- (n * (n - 1) / 2)^(-1 / 2)

e_Vx <- lo * cos(pi * exp_dist)
e_Vy <- lo * sin(pi * exp_dist)

ggplot(mapping=aes( x=e_Vx, y=e_Vy)) +
  geom_point() + 
  coord_fixed()
```


## Exploratory data analysis

Firstly we look at data structure(str) which gives us information about number of observations(rows) and columns, column names and types and a head of the first observations. Secondly we look at the data summary - numbers of zeros, missing values, infinite numbers and unique values. 

```{r}

str(mandatory_data)
glimpse(mandatory_data)

status(mandatory_data) 
summary(mandatory_data)

describe(mandatory_data)

profiling_num(mandatory_data) %>% select(variable, mean, std_dev, range_98)

```



```{r}
# korelacie vybranych numerickych atributov - TMP, WND_ANGLE, WND_SPEED, VIS, SLP, CIG, DEW
mdata_select <- select(all_data, TMP, WND_ANGLE, WND_SPEED, VIS, SLP, CIG, DEW, SNOW_DEPTH, PWO, GSO, LP24)
mdata_cor <- cor(mdata_select, use = "na.or.complete")

corrplot(mdata_cor, tl.col = "black", order = "AOE")
corrplot(mdata_cor, method = "shade", shade.col = NA, tl.col = "black", addCoef.col = "black", order = "AOE")

# Najvyššia korelácia je medzi TMP a DEW, slabá korelácia medzi TMP a VIS a medzi VIS a CIG. 
# Veľmi slabú zápornú koreláciu má aj SLP so stĺpcami DEW a TMP. 

```



```{r}
pairs(~TMP + SLP+DEW+VIS+WND_SPEED+CIG+WND_ANGLE+ SLP, data=mandatory_data)
```




```{r}
all_data_split_date <- mutate(
    all_data, 
    time = format(as_datetime(DATE), format = "%H:%M:%S"),
    date = format(as_date(DATE), format = "%Y-%m-%d"),
    month = month(DATE),
    year = year(DATE),
    md = substr(DATE, start = 6, stop = 10)
  )

data_temperature <- all_data_split_date %>% dplyr::select('DATE', 'TMP', 'time', 'date', 'year', 'month', 'md')
data_temperature <- data_temperature[!is.na(data_temperature$TMP), ]
data_temperature

```


```{r}
# priemerna denna teplota 
df_dayMean_tmp <- data_temperature %>% group_by(date) %>% summarise(tmp = na.omit(mean(TMP)), year = year, md = md)
df_dayMean_tmp <- unique(df_dayMean_tmp)
df_dayMean_tmp  


ggplot(df_dayMean_tmp, aes(x = as.Date(date), y = tmp)) +
  geom_line(color = "#4b9295") + 
  geom_smooth(color = 2) +
  labs(title = "Priemerné denné teploty: 1973 - 2020", x = "dátum", y = "teplota") +
  scale_x_date(date_breaks = "2 year", date_labels = "%Y") +
  theme(axis.text.x=element_text(angle=60, hjust=1)) +
  scale_y_continuous(breaks = seq(-30,30, by = 3))


table_dayMean_tmp <- data.table(year = df_dayMean_tmp$year, md = df_dayMean_tmp$md, tmp = df_dayMean_tmp$tmp)
table_dayMean_tmp

# vytvorenie tabulky 
# table_year_md_tmp <- dcast(table_dayMean_tmp, formula = year ~ md, value.var = 'tmp' ) # riadky = roky, stlpce = dni
table_year_md_tmp <- dcast(table_dayMean_tmp, formula = md ~ year, value.var = 'tmp' ) # riadky = dni, stlpce = roky
table_year_md_tmp

```


```{r}
# SOM mapa -> roky a dni
# vytvorenie matice
set.seed(123)
data_md_matrix <- as.matrix(table_year_md_tmp[,-1])
dim(data_md_matrix)

som_grid <- kohonen::somgrid(xdim = 4, ydim = 3, topo = "hexagonal")

som_model <- kohonen::som(X = data_md_matrix, grid = som_grid,
              rlen = 200, alpha = c(0.05,0.01), keep.data = T, dist.fcts = "euclidean", radius = 9)

plot(som_model, type="changes")

graphics::plot(som_model, type = "codes", shape = "straight")

som_model$unit.classif # zadelenie dni do tried
table(som_model$unit.classif)

som_model$grid
som_model$codes[[1]]

degrade.bleu <- function(n){
  return(rgb(0,0.4,1,alpha=seq(0,1,1/n)))
}

plot(som_model,type="count",palette.name=degrade.bleu)

dc <- dist(som_model$codes[[1]])

cah <- hclust(dc,method="ward.D2",members=table(som_model$unit.classif))
plot(cah,hang=-1,labels=F)

groupes <- cutree(cah,k=3)
print(groupes)
```



```{r}
# priemerna mesacna teplota 
df_monthMean_tmp <- data_temperature %>% group_by(year,month) %>% summarise(tmp = na.omit(mean(TMP)), date = date)
df_monthMean_tmp

ggplot(df_monthMean_tmp, aes(x = as.Date(date), y = tmp)) +
  geom_line( color="#882545") + 
  geom_smooth(color = 4) +
  labs(title = "Priemerné mesačné teploty: 1973 - 2020", x = "dátum", y = "teplota") +
  scale_x_date(date_breaks = "2 year", date_labels = "%Y") +
  theme(axis.text.x=element_text(angle=60, hjust=1)) +
  scale_y_continuous(breaks = seq(-30,30, by = 3))


table_monthMean_tmp <- data.table(year = df_monthMean_tmp$year, month = df_monthMean_tmp$month, tmp = df_monthMean_tmp$tmp)
table_monthMean_tmp <- unique(table_monthMean_tmp)
table_monthMean_tmp

# vytvorenie tabulky 
table_year_month_tmp <- dcast(table_monthMean_tmp, formula = year ~ month, value.var = 'tmp' ) # riadky = roky, stlpce = dni
# table_year_month_tmp <- dcast(table_monthMean_tmp, formula = month ~ year, value.var = 'tmp' ) # riadky = dni, stlpce = roky
table_year_month_tmp

# matica
data_month_matrix <- as.matrix(table_year_month_tmp[,-1])
dim(data_month_matrix)

# HEATMAP
library(RColorBrewer)
heatmap(data_month_matrix, 
        labRow = sort(table_year_month_tmp$year), 
        scale = 'none', 
        main = "Heatmap (teplota ~ mesiac ~ rok)", 
        col = colorRampPalette(c("#1d539f", "#408ab5" ,"#74ADD1", "#ABD9E9" ,"#E0F3F8" ,"#FFFFBF", "#feea90", "#fd9f68", "#a70146"))(25))


h <- stats::hclust(dist(data_month_matrix), method = "ward.D")
plot(h, labels = table_year_month_tmp$year, sub = "")



# SOM mapa -> roky a mesiace
som_grid <- kohonen::somgrid(xdim = 3, ydim = 2, topo = "hexagonal")

som_model <- kohonen::som(X = data_month_matrix, grid = som_grid,
              rlen = 200, alpha = c(0.05,0.01), keep.data = T, dist.fcts = "euclidean", radius = 4)

plot(som_model, type="changes")

graphics::plot(som_model, type = "codes", shape = "straight")

som_model$unit.classif # zadelenie mesiacov do tried
table(som_model$unit.classif) # pocty v triedach


df <- data.frame(Year = c(1973:2020), Class = som_model$unit.classif)
df

# 1.skupina - 1973,76,77,78,79,80,81,84,91,97,2004
# 2.skupina - 89,90,92,99,2001,2002,2011,2016
# 3.skupina - 74,75,83,88,94,95,98,2007
# 4.skupina - 82,85,86,87,93,96,2005,2006
# 5.skupina - 2000,2003,2009,2010,2012,2017
# 6.skupina - 2008,2013,14,15,18,19,2020

df_1 <- df_monthMean_tmp %>% filter(year %in% c(1973,1976,1977,1978,1979,1980,1981,1984,1991,1997,2004)) %>% group_by(year) %>% summarise(mean_tmp = mean(tmp))
tmp_1_mean <- mean(df_1$mean_tmp)

df_2 <- df_monthMean_tmp %>% filter(year %in% c(1989,1990,1992,1999,2001,2002,2011,2016)) %>% group_by(year) %>% summarise(mean_tmp = mean(tmp))
tmp_2_mean <- mean(df_2$mean_tmp)

df_3 <- df_monthMean_tmp %>% filter(year %in% c(1974,1975,1983,1988,1994,1995,1998,2007)) %>% group_by(year) %>% summarise(mean_tmp = mean(tmp))
tmp_3_mean <- mean(df_3$mean_tmp)

df_4 <- df_monthMean_tmp %>% filter(year %in% c(1982,1985,1986,1987,1993,1996,2005,2006)) %>% group_by(year) %>% summarise(mean_tmp = mean(tmp))
tmp_4_mean <- mean(df_4$mean_tmp)

df_5 <- df_monthMean_tmp %>% filter(year %in% c(2000,2003,2009,2010,2012,2017)) %>% group_by(year) %>% summarise(mean_tmp = mean(tmp))
tmp_5_mean <- mean(df_5$mean_tmp)

df_6 <- df_monthMean_tmp %>% filter(year %in% c(2008,2013,2014,2015,2018,2019,2020)) %>% group_by(year) %>% summarise(mean_tmp = mean(tmp))
tmp_6_mean <- mean(df_6$mean_tmp)

tmp_1_mean
tmp_2_mean
tmp_3_mean
tmp_4_mean
tmp_5_mean
tmp_6_mean

```






```{r}
# Predikcia na 1 rok

df_monthMean_tmp <- df_monthMean_tmp %>% dplyr::select(year,month,tmp)
df_monthMean_tmp <- unique(df_monthMean_tmp)

data_ts <- ts(df_monthMean_tmp$tmp, start = c(1973, 1), end = c(2020, 12), frequency = 12)
data_ts

arima_model <- auto.arima(data_ts)
summary(arima_model)
fore_arima = forecast::forecast(arima_model, h = 12)
df_arima = as.data.frame(fore_arima)
df_arima

```

```{r}
df_dayMean_tmp <- data_temperature %>% group_by(date) %>% summarise(tmp = na.omit(mean(TMP)), date = date)
df_dayMean_tmp <- unique(df_dayMean_tmp)
df_dayMean_tmp$date_ts <- c(1:length(df_dayMean_tmp$date))
df_dayMean_tmp

# time series LM 
lm_ts <- lm(formula = tmp ~ date_ts, data = df_dayMean_tmp)
lm_ts$coefficients


attach(df_dayMean_tmp)

pairs( ~ date_ts + tmp, panel = function(x,y){
  points(x,y)
  abline(lm(y~x), col = 2)})

```


```{r}
# zrazky a tmp linearna regresia
df_dayMean_tmp <- data_temperature %>% group_by(date) %>% summarise(tmp = na.omit(mean(TMP)), date = date)
df_dayMean_tmp <- unique(df_dayMean_tmp)
df_dayMean_tmp


data_lp <- all_data_split_date %>% dplyr::select('DATE', 'LP', 'time', 'date', 'year', 'month', 'md')
data_lp <- data_lp[!is.na(data_lp$LP), ] %>% separate(LP, c('LPtime', 'LP', NA, NA), sep=',') 
data_lp$LP <- as.double(data_lp$LP)
data_lp <-  data_lp %>% dplyr::mutate(LP = map_dbl(.$LP, process_col, 10))
data_lp <- data_lp[!is.na(data_lp$LP), ]
data_lp

df_dayMean_lp <- data_lp %>% dplyr::group_by(date) %>% summarise(lp = na.omit(mean(LP)), date = date)
df_dayMean_lp <- unique(df_dayMean_lp)
df_dayMean_lp


df_tmp_lp <- merge(x = df_dayMean_lp, y = df_dayMean_tmp, by = "date", all.y = T) 
df_tmp_lp$lp[is.na(df_tmp_lp$lp)] <- 0 # ak niekde chyba hodnota LP, LP = 0
df_tmp_lp


# linearna regresia
# Hypoteza: Rocna teplota rastie a s nou rastie aj mnozstvo zrazok
normalize <- function(x) {
  return ((x - min(x)) / (max(x) - min(x)))
}
df_tmp_lp$lp <- normalize(df_tmp_lp$lp)
df_tmp_lp$tmp <- normalize(df_tmp_lp$tmp)
df_tmp_lp

attach(df_tmp_lp)


tmp_lp_model <- lm(formula = lp ~ tmp, data = df_tmp_lp)
summary(tmp_lp_model)

pairs( ~ tmp + lp, panel = function(x,y){
  points(x,y)
  abline(lm(y~x), col = 2)})


```

```{r}

add_group <- function(val) {
  
  if(val <= -20){
    return(as.numeric(1))
  }
  if(val <= -10){
    return(as.numeric(2))
  }
  if(val <= 0){
    return(as.numeric(3))
  }
  if(val <= 10){
    return(as.numeric(4))
  }
  if(val <= 20){
    return(as.numeric(5))
  }
  if(val > 20){
    return(as.numeric(6))
  }
  
} 

df_dayMean_tmp <- df_dayMean_tmp %>% dplyr::mutate(
    group = map_dbl(tmp, add_group)
)

df_tmp_groups <- df_dayMean_tmp %>% group_by(year, group) %>% count()
df_tmp_groups$group <- factor(df_tmp_groups$group)


table_groups <- as.data.table(df_tmp_groups)


# vytvorenie tabulky - pocty dni 
table_groups_tmp <- dcast(table_groups, formula = year ~ group, value.var = 'n' , fill = 0)
table_groups_tmp

ggplot(data = df_tmp_groups %>% filter(group == 1), aes(x=year, y=n, fill=group)) +
  geom_bar(stat="identity", fill = "#108dad") +
  theme(axis.text.x=element_text(angle=60, hjust=1)) +
  scale_y_continuous(breaks = seq(0,10, by = 1)) +
  scale_x_continuous(breaks = seq(1973,2020, by = 1)) +
  labs(title = paste("Počty dní kedy bola priemerná teplota pod -20°C"), y = "Počet dní", x = "Rok")
  

ggplot(data = df_tmp_groups %>% filter(group == 2), aes(x=year, y=n, fill=group)) +
  geom_bar(stat="identity", fill = "#3cacc8") +
  theme(axis.text.x=element_text(angle=60, hjust=1)) +
  scale_y_continuous(breaks = seq(0,30, by = 2)) +
  scale_x_continuous(breaks = seq(1973,2020, by = 2)) +
  labs(title = paste("Počty dní kedy bola priemerná teplota od -20°C až -10°C"), y = "Počet dní", x = "Rok")

ggplot(data = df_tmp_groups %>% filter(group == 3), aes(x=year, y=n, fill=group)) +
  geom_bar(stat="identity", fill = "#4dc7ba") +
  theme(axis.text.x=element_text(angle=60, hjust=1)) +
  scale_y_continuous(breaks = seq(0,100, by = 5)) +
  scale_x_continuous(breaks = seq(1973,2020, by = 2)) +
  labs(title = paste("Počty dní kedy bola priemerná teplota od -10°C až 0°C"), y = "Počet dní", x = "Rok")

ggplot(data = df_tmp_groups %>% filter(group == 4), aes(x=year, y=n, fill=group)) +
  geom_bar(stat="identity", fill = "#67be55") +
  theme(axis.text.x=element_text(angle=60, hjust=1)) +
  scale_y_continuous(breaks = seq(0,200, by = 10)) +
  scale_x_continuous(breaks = seq(1973,2020, by = 2)) +
  labs(title = paste("Počty dní kedy bola priemerná teplota od 0°C až 10°C"), y = "Počet dní", x = "Rok")

ggplot(data = df_tmp_groups %>% filter(group == 5), aes(x=year, y=n, fill=group)) +
  geom_bar(stat="identity", fill = "#bdb932") +
  theme(axis.text.x=element_text(angle=60, hjust=1)) +
  scale_y_continuous(breaks = seq(0,200, by = 10)) +
  scale_x_continuous(breaks = seq(1973,2020, by = 2)) +
  labs(title = paste("Počty dní kedy bola priemerná teplota od 10°C až 20°C"), y = "Počet dní", x = "Rok")

ggplot(data = df_tmp_groups %>% filter(group == 6), aes(x=year, y=n, fill=group)) +
  geom_bar(stat="identity", fill = "#c64539") +
  theme(axis.text.x=element_text(angle=60, hjust=1)) +
  scale_y_continuous(breaks = seq(0,200, by = 3)) +
  scale_x_continuous(breaks = seq(1973,2020, by = 2)) +
  labs(title = paste("Počty dní kedy bola priemerná teplota nad 20°C"), y = "Počet dní", x = "Rok")


```
