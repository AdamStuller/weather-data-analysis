---
title: "Preprocessing"
output: html_document
---

```{r, include = FALSE}
source('setup.R')
```



```{r NA, echo = FALSE}

NA_values <- c("", '999', '9999', '99999', '999999', '+999', '+9999','+99999', '+999999', '009999')

process_col <- function(val, scaling = 1) {
  if (is.na(as.numeric(val)) || as.numeric(val) %in% NA_values){
    val <- NA
  }
  return (as.numeric(val)/scaling)
} 

```

## Loading of documents (years 1973 - 2020)

```{r setup}
#selected_cols <- c('STATION', 'DATE', 'TMP', 'WND_ANGLE', 'WND_SPEED', 'VIS', 'SLP', 'CIG', 'DEW', 'LATITUDE', 'LONGITUDE', 'ELEVATION','SNOW_DEPTH', 'PWO', 'NAME','GSO')


#allfiles <- list.files(path = "../data", pattern = "*.csv", full.names = T)
#data_sliac <- data.table::rbindlist(lapply(allfiles, function(x) cbind(fread(x, fill = T), gsub(".csv", "", x))), fill = T)
#data_sliac <- as.data.frame(data_sliac)
#View(data_sliac)

selected_cols <- c('STATION', 'DATE', 'TMP', 'WND_ANGLE', 'WND_SPEED', 'VIS', 'SLP', 'CIG', 'DEW','SNOW_DEPTH', 'PWO','GSO')

```

```{r}
read.csv(file= "../data/all_data.csv") %>% 
  dplyr::filter(STATION == 11903099999 | STATION == 11927599999 ) %>%
  dplyr::mutate(
      year = ymd_hms(DATE) %>% 
        lubridate::year() %>% 
        map_chr(~ as.character(.x))
    ) %>%
  dplyr::filter(year >= 1973 & year <2021) %>%
  separate(TMP, c('TMP', NA), sep=',')  %>% 
  separate(WND, c('WND_ANGLE', NA, NA, 'WND_SPEED', NA)) %>%
  separate(VIS, c('VIS', NA, NA, NA)) %>% 
  separate(SLP, c('SLP', NA)) %>% 
  separate(CIG, c('CIG', NA, NA, NA)) %>% 
  separate(DEW, c('DEW', NA), sep=',') %>% 
  separate(AJ1, c('SNOW_DEPTH', NA, NA, NA, NA, NA, NA)) %>%
  separate(AY1, c('PWO', NA, NA, NA)) %>% 
  separate(IA1, c('GSO', NA)) %>%
  dplyr::mutate(
    TMP = map_dbl(.$TMP,  process_col, 10),
    TMP = na_if(TMP, 999.9),
    WND_ANGLE = map_dbl(.$WND_ANGLE, process_col),
    WND_SPEED = map_dbl(.$WND_SPEED, process_col, 10),
    VIS = map_dbl(.$VIS, process_col),
    SLP = map_dbl(.$SLP, process_col, 10),
    CIG = map_dbl(.$CIG, process_col),
    DEW = map_dbl(.$DEW, process_col, 10),
    SNOW_DEPTH = map_dbl(.$SNOW_DEPTH, process_col),
    PWO = dplyr::na_if(PWO, ""),
    GSO = dplyr::na_if(GSO, "")
  ) %>%

  dplyr::select(all_of(selected_cols)) %>% 
  write.csv(file="../data/all.csv")

```

```{r}
all_data <- read.csv(file= "../data/all.csv")
View(all_data)

```


# Kruhovy graf G17

Dufal som ze to bude jednoduche ale exponencialne rozdelenie aj normalne aj to nase mi dava uplne presne kruhy, takze tak bude asi nejaka chyba... pockame, kum to Michal urobi pre erko. 

```{r}
n <- nrow(mandatory_data)
lo <- (n * (n - 1) / 2)^(-1 / 2)

Vx <- lo * cos(pi * mandatory_data$TMP)
Vy <- lo * sin(pi * mandatory_data$TMP)

ggplot(mapping=aes( x=Vx, y=Vy)) +
  geom_point() + 
  coord_fixed()
```
```{r}
normal_dist <- rnorm(-20:40, n = 2000) 

n <- length(normal_dist)
lo <- (n * (n - 1) / 2)^(-1 / 2)

Vx <- lo * cos(pi * normal_dist)
Vy <- lo * sin(pi * normal_dist)

ggplot(mapping=aes( x=Vx, y=Vy)) +
  geom_point() + 
  coord_fixed()

```
```{r}
exp_dist <- rexp(20000)

n <- length(exp_dist)
lo <- (n * (n - 1) / 2)^(-1 / 2)

e_Vx <- lo * cos(pi * exp_dist)
e_Vy <- lo * sin(pi * exp_dist)

ggplot(mapping=aes( x=e_Vx, y=e_Vy)) +
  geom_point() + 
  coord_fixed()
```


## Exploratory data analysis

Firstly we look at data structure(str) which gives us information about number of observations(rows) and columns, column names and types and a head of the first observations. Secondly we look at the data summary - numbers of zeros, missing values, infinite numbers and unique values. 

```{r}

str(mandatory_data)
glimpse(mandatory_data)

status(mandatory_data) 
summary(mandatory_data)

describe(mandatory_data)

profiling_num(mandatory_data) %>% select(variable, mean, std_dev, range_98)

```



```{r}
# korelacie vybranych numerickych atributov - TMP, WND_ANGLE, WND_SPEED, VIS, SLP, CIG, DEW
mdata_select <- select(all_data, TMP, WND_ANGLE, WND_SPEED, VIS, SLP, CIG, DEW, SNOW_DEPTH, PWO, GSO, LP24)
mdata_cor <- cor(mdata_select, use = "na.or.complete")

corrplot(mdata_cor, tl.col = "black", order = "AOE")
corrplot(mdata_cor, method = "shade", shade.col = NA, tl.col = "black", addCoef.col = "black", order = "AOE")

# Najvyššia korelácia je medzi TMP a DEW, slabá korelácia medzi TMP a VIS a medzi VIS a CIG. 
# Veľmi slabú zápornú koreláciu má aj SLP so stĺpcami DEW a TMP. 

```



```{r}
pairs(~TMP + SLP+DEW+VIS+WND_SPEED+CIG+WND_ANGLE+ SLP, data=mandatory_data)
```




```{r}
all_data_split_date <- mutate(
    all_data, 
    time = format(as_datetime(DATE), format = "%H:%M:%S"),
    date = format(as_date(DATE), format = "%Y-%m-%d"),
    month = month(DATE),
    year = year(DATE)
  )

data_temperature <- all_data_split_date %>% select('DATE', 'TMP', 'time', 'date', 'year', 'month')
data_temperature <- data_temperature[!is.na(data_temperature$TMP), ]
data_temperature


```


```{r}
df_dayMean_tmp <- data_temperature %>% group_by(date) %>% summarise(tmp = na.omit(mean(TMP)), year = year)
df_dayMean_tmp <- unique(df_dayMean_tmp)
df_dayMean_tmp$md <- substr(df_dayMean_tmp$date, start = 6, stop = 10)
df_dayMean_tmp <- df_dayMean_tmp[,-1]  
df_dayMean_tmp  

monthDay <- sort(unique(df_dayMean_tmp$md))

table_dayMean_tmp <- data.table(year = df_dayMean_tmp$year, md = df_dayMean_tmp$md, tmp = df_dayMean_tmp$tmp)

table_dayMean_tmp


p <- dcast(table_dayMean_tmp, formula = year ~ md, value.var = 'tmp' )
p

```



```{r}
# priemerna mesacna teplota 
df_monthMean_tmp <- data_temperature %>% group_by(year,month) %>% summarise(tmp = na.omit(mean(TMP)))
df_monthMean_tmp

table_monthMean_tmp <- data.table(year = df_monthMean_tmp$year, month = df_monthMean_tmp$month, tmp = df_monthMean_tmp$tmp)
table_monthMean_tmp

p <- dcast(table_monthMean_tmp, formula = year ~ month, value.var = 'tmp' )
p

data_month_matrix <- as.matrix(p[,-1])
dim(data_month_matrix)

library(RColorBrewer)
heatmap(data_month_matrix, 
        labRow = sort(p$year), 
        scale = 'none', 
        main = "Heatmap (teplota ~ mesiac ~ rok)", 
        col = colorRampPalette(c("#1d539f", "#408ab5" ,"#74ADD1", "#ABD9E9" ,"#E0F3F8" ,"#FFFFBF", "#FEE090","#fd9268",   "#9E0142"))(25))


h <- stats::hclust(dist(data_month_matrix), method = "ward.D")
plot(h, labels = p$year, sub = "")


```





```{r}
data_month_matrix

som_grid <- kohonen::somgrid(xdim = 3, ydim = 2, topo = "hexagonal")

som_model <- kohonen::som(X = data_month_matrix, grid = som_grid,
              rlen = 200, alpha = c(0.05,0.01), keep.data = T, dist.fcts = "euclidean", radius = 4)

plot(som_model, type="changes")

p1 <- ~graphics::plot(som_model, type = "count", shape = "straight", palette.name = terrain.colors, heatkeywidth = 0.2)
p2 <- ~graphics::plot(som_model, type = "dist.neighbours", shape = "straight", palette.name = terrain.colors)
plot(p2)

graphics::plot(som_model, type = "codes", shape = "straight")

somkody <- as.data.frame(t(som_model$codes[[1]]))
somkody

som_model$unit.classif # zadelenie rokov do tried
table(som_model$unit.classif)

roky <- c(1973:2020)
roky

klastre <- data.frame(rok = roky, trieda = som_model$unit.classif)
klastre %>% filter(trieda == 6)


ggplot(data.table(Month = 1:12, Tmp = somkody[,1]), aes(Month, Tmp)) +
  geom_line(size = 1) + geom_point(size = 2) + 
  geom_smooth(method = 'loess', formula = 'y ~ x',se = F) +
  scale_y_continuous(breaks = seq(-10, 30, by = 2)) +
  labs(x = "Month", y = "Tmp") +
  theme_bw() 


measures1 <- c(1)
som1 <- kohonen::som(scale(data_month_matrix[,measures1]), grid = kohonen::somgrid(3, 2, "rectangular"))
plot(som1, main = "Default SOM Plot")

# reverse color ramp
colors <- function(n, alpha = 1) {
    rev(heat.colors(n, alpha))
}
plot(som1, type = "counts", palette.name = colors, heatkey = TRUE)
par(mfrow = c(1, 2))
plot(som1, type = "mapping", pchs = 20, main = "Mapping Type SOM")
plot(som1, type = "dist.neighbours", palette.name = terrain.colors)

som1$unit.classif
```
