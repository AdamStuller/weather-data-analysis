---
title: "Preprocessing"
output: html_document
---

```{r, include=FALSE}
# install.packages("tidyverse")
# install.packages("funModeling")
# install.packages("Hmisc")
# install.packages('data.table')
library(lubridate)
library(tidyverse)
library(Hmisc)
library(data.table)
library(funModeling)
```



```{r NA, echo=FALSE}

process_col <- function(val, scaling = 1) {
  if (is.na(val) || val %in% NA_values){
    val <- NA
  }
  return (as.numeric(val)/scaling)
} 

```

## Loading of documents (years 2010 - 2020)

```{r setup}

NA_values <- c("", '999', '9999', '99999', '999999', '+999', '+9999', '+99999', '+999999')
selected_cols <- c('STATION', 'DATE', 'TMP', 'WND_ANGLE', 'WND_SPEED', 'VIS', 'SLP', 'CIG', 'DEW', 'LATITUDE', 'LONGITUDE', 'ELEVATION', 'NAME')


allfiles <- list.files(path = "../data", pattern = "*.csv", full.names = T)

data_sliac <- data.table::rbindlist(lapply(allfiles, function(x) cbind(fread(x, fill = T), gsub(".csv", "", x))), fill = T)

data_sliac <- as.data.frame(data_sliac)
#View(data_sliac)

```

```{r}

#data_sliac <- read.csv('../data/2010.csv')

mandatory_data <- data_sliac %>%
  separate(TMP, c('TMP', NA), sep=',')  %>% 
  separate(WND, c('WND_ANGLE', NA, NA, 'WND_SPEED', NA)) %>%
  separate(VIS, c('VIS', NA, NA, NA)) %>% 
  separate(SLP, c('SLP', NA)) %>% 
  separate(CIG, c('CIG', NA, NA, NA)) %>% 
  separate(DEW, c('DEW', NA), sep=',') %>% 
  dplyr::mutate(
    TMP = map_dbl(.$TMP,  process_col, 10),
    WND_ANGLE = map_dbl(.$WND_ANGLE, process_col),
    WND_SPEED = map_dbl(.$WND_SPEED, process_col, 10),
    VIS = map_dbl(.$VIS, process_col),
    SLP = map_dbl(.$SLP, process_col, 10),
    CIG = map_dbl(.$CIG, process_col),
    DEW = map_dbl(.$DEW, process_col, 10),
    #DATE = map(.$DATE, ~ as.Date(.x))
    
  ) %>%
  dplyr::select(all_of(selected_cols))

View(mandatory_data)
```


## Split date into seperated columns
## Filter each 6 hours

```{r}

mandatory_date_split <- mutate(mandatory_data, day = mday(DATE), month = month(DATE), year = year(DATE), 
                   hour = hour(DATE), min = minute(DATE))
mandatory_date_split

# Select each 6 hours
data_6_hours <- mandatory_date_split %>% filter(hour %in% c(0,6,12,18))
data_6_hours

# Select January 2010
jan_2010 <- filter(data_6_hours, month == 1, year == 2010)
jan_2010

ggplot(data = jan_2010) + 
  geom_line(aes(DATE, TMP), size = 0.8, col = 2) +
  geom_point(mapping = aes(x = DATE, y = TMP), size = 1.3) +
  labs(title = "Temperature 2020", y = "TMP") 


# Select January 2020
jan_2020 <- filter(data_6_hours, month == 1, year == 2020)
jan_2020

ggplot(data = jan_2020) + 
  geom_line(aes(DATE, TMP), size = 0.8, col = 2) +
  geom_point(mapping = aes(x = DATE, y = TMP), size = 1.3) +
  labs(title = "Temperature 2020", y = "TMP") 
 
# Mean TMP 2010
mean_2010 <- filter(data_6_hours, year == 2010)

mean_tmp_2010 <- mean_2010 %>% group_by(month) %>% summarise(mean = mean(TMP))
mean_tmp_2010

ggplot(mean_tmp_2010) + 
  geom_col(mapping = aes(x = month, y = mean, fill = as.factor(month))) +
  geom_line(mapping = aes(x = month, y = mean), size = 0.8)


# Mean TMP 2020
mean_2020 <- filter(data_6_hours, year == 2020)

mean_tmp_2020 <- mean_2020 %>% group_by(month) %>% summarise(mean = mean(TMP))
mean_tmp_2020

ggplot(mean_tmp_2020) + 
  geom_col(mapping = aes(x = month, y = mean, fill = as.factor(month))) +
  geom_line(mapping = aes(x = month, y = mean), size = 0.8)
  

```


```{r}

# modus
getmode <- function(v) {
   uniqv <- unique(v)
   uniqv[which.max(tabulate(match(v, uniqv)))]
}

getmode(na.omit(mandatory_data$TMP))
getmode(na.omit(mandatory_data$WND_ANGLE))
getmode(na.omit(mandatory_data$WND_SPEED))
getmode(na.omit(mandatory_data$VIS))
getmode(na.omit(mandatory_data$SLP))
getmode(na.omit(mandatory_data$CIG))
getmode(na.omit(mandatory_data$DEW))



# ggplot

x <- qqnorm(mandatory_data$TMP)
abline(0,1, col = "red")

plot.qqline(mandatory_data$TMP)
#qqline(mandatory_data$TMP)

ggplot(mandatory_data$TMP)+
  geom_line()
plot(qqline(mandatory_data$TMP))

qplot(sample = TMP, data = mandatory_data) +
  stat_qq()

ggplot(mandatory_data, aes(sample=TMP),  na.rm = T)+stat_qq(na.rm = T) + 
  geom_abline()

```



# Mean daily temperature

```{r NA, eval=FALSE}

mean_tmp <- mandatory_data %>%
  dplyr::mutate(DAY =  ymd_hms(DATE)) %>%
  dplyr::group_by(month=floor_date(DAY, unit="month")) %>%
  dplyr::summarise(mean = mean(TMP)) 

months <- c('JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC')

ggplot(data = mean_tmp) + 
  geom_col(mapping=aes(x=factor(months,months), y=mean)) +
  labs(title="Priemerna mesačná teplota za rok 2019", y="Teplota", x="Mesiace")
```

### Firstly we must have a look at temperature 

According to isd documentation, under TMP field there are two information. AIR-TEMPERATURE-OBSERVATION air temperature which concerns us and should be numeric, with sign prefix. If any value is missing 9999 represents it. It is scaled up tenfold. 

Second information does not concern us and is thus removed. Both values are separated and only temperature is kept. Temperature is then converted to numeric (if not 9999) and divided by 10.     

Similarly we need to process other attributes: Wind, Visibility, Pressure, Ceiling and Dew.

# AIR-TEMPERATURE-OBSERVATION dew point temperature

The temperature to which a given parcel of air must be cooled at constant pressure and water vapor content in order for saturation to occur.

MIN: -0982 
MAX: +0368 
UNITS: Degrees Celsius 
SCALING FACTOR: 10 
DOM: A general domain comprised of the numeric characters (0-9), a plus sign (+), and a minus sign (-).

+9999 = Missing.






### Exploratory data analysis

Firstly we look at data structure(str) which gives us information about number of observations(rows) and columns, column names and types and a head of the first observations. Secondly we look at the data summary - numbers of zeros, missing values, infinite numbers and unique values. 

```{r}

str(mandatory_data)
glimpse(mandatory_data)

status(mandatory_data) 
summary(mandatory_data)

describe(mandatory_data)

```


As we can see there are no categorical variables in our data, so let's have a look at numerical variables. 

### Analyzing numerical variables

```{r}

profiling_num(mandatory_data) %>% select(variable, mean, std_dev, range_98)

```


For each variable there is a histogram showing values frequency and boxplot which helps us detect potential outliers and also visualize minimum, maximum, median, 1.(0.25) and 3. quartiles (0.75). All observations above (q(0.75) + 1.5*IQR) or below (q(0.25) - 1.5*IQR) are considered as potential outliers (IQR = difference between 3. and 1. quartile). Such observations are displayed as points in the boxplot.


### Temperature

```{r}
summary(mandatory_data$TMP)
mandatory_data['TMP'] %>% profiling_num()


hist(mandatory_data$TMP,
  xlab = "TMP",
  main = "Temperature histogram",
  breaks = 50,
  col = 2
)

boxplot(mandatory_data$TMP, col = 2, ylab = "TMP", main = "Temperature boxplot")

```

### Wind angle

```{r}
summary(mandatory_data$WND_ANGLE)
mandatory_data['WND_ANGLE'] %>% profiling_num()


hist(mandatory_data$WND_ANGLE,
  xlab = "WND_ANGLE",
  main = "Wind angle histogram",
  breaks = sqrt(nrow(mandatory_data)/4),
  col = 3
)

boxplot(mandatory_data$WND_ANGLE, col = 3, ylab = "WND_ANGLE", main = "Wind angle boxplot")

```

### Wind speed

```{r}
summary(mandatory_data$WND_SPEED)
mandatory_data['WND_SPEED'] %>% profiling_num()


hist(mandatory_data$WND_SPEED,
  xlab = "WND_SPEED",
  main = "Wind speed histogram",
  breaks = 10,
  col = 4
)

boxplot(mandatory_data$WND_SPEED, col = 4, ylab = "WND_SPEED", main = "Wind speed boxplot")

```

### Visibility

```{r}
summary(mandatory_data$VIS)
mandatory_data['VIS'] %>% profiling_num()


hist(mandatory_data$VIS,
  xlab = "VIS",
  main = "Visibility histogram",
  breaks = 30,
  col = 5
)

boxplot(mandatory_data$VIS, col = 5, ylab = "VIS", main = "Visibility boxplot")

```

### Pressure

```{r}
summary(mandatory_data$SLP)
mandatory_data['SLP'] %>% profiling_num()


hist(mandatory_data$SLP,
  xlab = "SLP",
  main = "Pressure histogram",
  breaks = sqrt(nrow(mandatory_data)/2),
  col = 6
)

boxplot(mandatory_data$SLP, col = 6, ylab = "SLP", main = "Pressure boxplot")

```

### Ceiling

```{r}
summary(mandatory_data$CIG)
mandatory_data['CIG'] %>% profiling_num()


hist(mandatory_data$CIG,
  xlab = "CIG",
  main = "Ceiling histogram",
  breaks = 20,
  col = 7
)

boxplot(mandatory_data$CIG, col = 7, ylab = "CIG", main = "Ceiling boxplot")

```

### Dew

```{r}
summary(mandatory_data$DEW)
mandatory_data['DEW'] %>% profiling_num()


hist(mandatory_data$CIG,
  xlab = "DEW",
  main = "Dew histogram",
  breaks = 20,
  col = 7
)

boxplot(mandatory_data$CIG, col = 7, ylab = "DEW", main = "Dew boxplot")

```

```{r}
#corr <- cor(mandatory_data[,3:8], use = "na.or.complete")

```
