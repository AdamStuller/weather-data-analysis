---
title: "Preprocessing"
output: html_document
---

```{r, include=FALSE}
# install.packages("tidyverse")
# install.packages("funModeling")
# install.packages("Hmisc")
# install.packages('data.table')
library(lubridate)
library(tidyverse)
library(Hmisc)
library(data.table)
library(funModeling)
```



```{r NA, echo=FALSE}

NA_values <- c("", '9999', '999', '99999', '999.9')

process_col <- function(val, scaling = 1) {
  if (is.na(val) || val %in% NA_values){
    val <- NA
  }
  return (as.numeric(val)/scaling)
} 

```

## Loading of documents (years 2010 - 2020)

```{r setup}

selected_cols <- c('STATION', 'DATE', 'TMP', 'WND_ANGLE', 'WND_SPEED', 'VIS', 'SLP', 'CIG', 'DEW', 'LATITUDE', 'LONGITUDE', 'ELEVATION','SNOW_DEPTH', 'PWO', 'NAME','GSO')


allfiles <- list.files(path = "../data", pattern = "*.csv", full.names = T)

data_sliac <- data.table::rbindlist(lapply(allfiles, function(x) cbind(fread(x, fill = T), gsub(".csv", "", x))), fill = T)

data_sliac <- as.data.frame(data_sliac)

```

```{r}

#data_sliac <- read.csv('../data/2010.csv')

mandatory_data <- data_sliac %>%
  separate(TMP, c('TMP', NA), sep=',')  %>% 
  separate(WND, c('WND_ANGLE', NA, NA, 'WND_SPEED', NA)) %>%
  separate(VIS, c('VIS', NA, NA, NA)) %>% 
  separate(SLP, c('SLP', NA)) %>% 
  separate(CIG, c('CIG', NA, NA, NA)) %>% 
  separate(DEW, c('DEW', NA), sep=',') %>% 
  separate(AJ1, c('SNOW_DEPTH', NA, NA, NA, NA, NA, NA)) %>%
  separate(AY1, c('PWO', NA, NA, NA)) %>% 
  separate(IA1, c('GSO', NA)) %>%
  dplyr::mutate(
    TMP = map_dbl(.$TMP,  process_col, 10),
    TMP = na_if(TMP, 999.9),
    WND_ANGLE = map_dbl(.$WND_ANGLE, process_col),
    WND_SPEED = map_dbl(.$WND_SPEED, process_col, 10),
    VIS = map_dbl(.$VIS, process_col),
    SLP = map_dbl(.$SLP, process_col, 10),
    CIG = map_dbl(.$CIG, process_col),
    DEW = map_dbl(.$DEW, process_col, 10),
    SNOW_DEPTH = map_dbl(.$SNOW_DEPTH, process_col),
    PWO = dplyr::na_if(PWO, ""),
    GSO = dplyr::na_if(GSO, "")
  ) %>%
  dplyr::select(all_of(selected_cols))

View(mandatory_data)
```





# Mean daily temperature

```{r NA, eval=FALSE}


mean_tmp <- mandatory_data %>%
  dplyr::mutate(DAY =  ymd_hms(DATE)) %>%
  dplyr::group_by(month=floor_date(DAY, unit="month")) %>%
  dplyr::summarise(mean = mean(TMP)) 

months <- c('JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC')

ggplot(data = mean_tmp) + 
  geom_col(mapping=aes(x=factor(months,months), y=mean)) +
  labs(title="Priemerna mesačná teplota za rok 2019", y="Teplota", x="Mesiace")
```


```{r}
ggplot(data = mandatory_data, aes(sample=TMP)) +
  stat_qq() + 
  stat_qq_line()
```


### Firstly we must have a look at temperature 
```{r}
#quantile(mandatory_data$TMP)

df <- mandatory_data %>%
  dplyr::select('TMP') %>%
  tidyr::gather(key='label', value = 'temp')

ggplot(data = df, aes(factor(label), temp, fill=label)) +
  geom_violin(draw_quantiles=c(0.25, 0.5, 0.75))
```


```{r}
df <- mandatory_data %>% 
  dplyr::mutate(
    year = ymd_hms(DATE) %>% 
      lubridate::year() %>% 
      map_chr(~ as.character(.x))
  ) %>%
  dplyr::select(all_of(c('year', 'TMP')))

ggplot(data = df, aes(factor(year), TMP, fill=year)) +
  geom_violin(draw_quantiles=c(0.25, 0.5, 0.75))

```


```{r}

df <- mandatory_data %>% 
  dplyr::mutate(
    year = ymd_hms(DATE) %>% 
      lubridate::year() %>% 
      map_chr(~ as.character(.x))
  ) %>%
  dplyr::select(all_of(c('year', 'TMP')))

ggplot(data = df, aes( TMP,factor(year), colour=year)) +
  geom_jitter() 
``` 

```{r}
df <- mandatory_data %>% 
  dplyr::mutate(
    year = ymd_hms(DATE) %>% 
      lubridate::year() %>% 
      map_chr(~ as.character(.x))
  ) %>%
  dplyr::select(all_of(c('year', 'TMP')))

ggplot(data = df, aes( TMP,factor(year), colour=year)) +
  geom_boxplot() 
```
# Kruhovy graf G17

Dufal som ze to bude jednoduche ale exponencialne rozdelenie aj normalne aj to nase mi dava uplne presne kruhy, takze tak bude asi nejaka chyba... pockame, kum to Michal urobi pre erko. 

```{r}
n <- nrow(mandatory_data)
lo <- (n * (n - 1) / 2)^(-1 / 2)

Vx <- lo * cos(pi * mandatory_data$TMP)
Vy <- lo * sin(pi * mandatory_data$TMP)

ggplot(mapping=aes( x=Vx, y=Vy)) +
  geom_point() + 
  coord_fixed()
```
```{r}
normal_dist <- rnorm(-20:40, n = 2000) 

n <- length(normal_dist)
lo <- (n * (n - 1) / 2)^(-1 / 2)

Vx <- lo * cos(pi * normal_dist)
Vy <- lo * sin(pi * normal_dist)

ggplot(mapping=aes( x=Vx, y=Vy)) +
  geom_point() + 
  coord_fixed()

```
```{r}
exp_dist <- rexp(20000)

n <- length(exp_dist)
lo <- (n * (n - 1) / 2)^(-1 / 2)

e_Vx <- lo * cos(pi * exp_dist)
e_Vy <- lo * sin(pi * exp_dist)

ggplot(mapping=aes( x=e_Vx, y=e_Vy)) +
  geom_point() + 
  coord_fixed()
```


According to isd documentation, under TMP field there are two information. AIR-TEMPERATURE-OBSERVATION air temperature which concerns us and should be numeric, with sign prefix. If any value is missing 9999 represents it. It is scaled up tenfold. 

Second information does not concern us and is thus removed. Both values are separated and only temperature is kept. Temperature is then converted to numeric (if not 9999) and divided by 10.     

Similarly we need to process other attributes: Wind, Visibility, Pressure, Ceiling and Dew.

# AIR-TEMPERATURE-OBSERVATION dew point temperature

The temperature to which a given parcel of air must be cooled at constant pressure and water vapor content in order for saturation to occur.

MIN: -0982 
MAX: +0368 
UNITS: Degrees Celsius 
SCALING FACTOR: 10 
DOM: A general domain comprised of the numeric characters (0-9), a plus sign (+), and a minus sign (-).

+9999 = Missing.



### Exploratory data analysis

Firstly we look at data structure(str) which gives us information about number of observations(rows) and columns, column names and types and a head of the first observations. Secondly we look at the data summary - numbers of zeros, missing values, infinite numbers and unique values. 

```{r}

str(mandatory_data)
glimpse(mandatory_data)

status(mandatory_data) 
summary(mandatory_data)

describe(mandatory_data)

```


As we can see there are no categorical variables in our data, so let's have a look at numerical variables. 

### Analyzing numerical variables

```{r}

profiling_num(mandatory_data) %>% select(variable, mean, std_dev, range_98)

```


For each variable there is a histogram showing values frequency and boxplot which helps us detect potential outliers and also visualize minimum, maximum, median, 1.(0.25) and 3. quartiles (0.75). All observations above (q(0.75) + 1.5*IQR) or below (q(0.25) - 1.5*IQR) are considered as potential outliers (IQR = difference between 3. and 1. quartile). Such observations are displayed as points in the boxplot.


### Temperature

```{r}
summary(mandatory_data$TMP)
mandatory_data['TMP'] %>% profiling_num()


hist(mandatory_data$TMP,
  xlab = "TMP",
  main = "Temperature histogram",
  breaks = sqrt(nrow(mandatory_data)/2),
  col = 2
)

boxplot(mandatory_data$TMP, col = 2, ylab = "TMP", main = "Temperature boxplot")

#boxplot.stats(mandatory_data$TMP)$out

```

```{r}

```


### Wind angle

```{r}
summary(mandatory_data$WND_ANGLE)
mandatory_data['WND_ANGLE'] %>% profiling_num()


hist(mandatory_data$WND_ANGLE,
  xlab = "WND_ANGLE",
  main = "Wind angle histogram",
  breaks = sqrt(nrow(mandatory_data)/4),
  col = 3
)

boxplot(mandatory_data$WND_ANGLE, col = 3, ylab = "WND_ANGLE", main = "Wind angle boxplot")

#boxplot.stats(mandatory_data$WND_ANGLE)$out

```

### Wind speed

```{r}
summary(mandatory_data$WND_SPEED)
mandatory_data['WND_SPEED'] %>% profiling_num()


hist(mandatory_data$WND_SPEED,
  xlab = "WND_SPEED",
  main = "Wind speed histogram",
  breaks = 10,
  col = 4
)

boxplot(mandatory_data$WND_SPEED, col = 4, ylab = "WND_SPEED", main = "Wind speed boxplot")

#boxplot.stats(mandatory_data$WND_SPEED)$out

```

### Visibility

```{r}
summary(mandatory_data$VIS)
mandatory_data['VIS'] %>% profiling_num()


hist(mandatory_data$VIS,
  xlab = "VIS",
  main = "Visibility histogram",
  breaks = 30,
  col = 5
)

boxplot(mandatory_data$VIS, col = 5, ylab = "VIS", main = "Visibility boxplot")

#boxplot.stats(mandatory_data$VIS)$out

```

### Pressure

```{r}
summary(mandatory_data$SLP)
mandatory_data['SLP'] %>% profiling_num()


hist(mandatory_data$SLP,
  xlab = "SLP",
  main = "Pressure histogram",
  breaks = sqrt(nrow(mandatory_data)/2),
  col = 6
)

boxplot(mandatory_data$SLP, col = 6, ylab = "SLP", main = "Pressure boxplot")

#boxplot.stats(mandatory_data$SLP)$out
```

### Ceiling

```{r}
summary(mandatory_data$CIG)
mandatory_data['CIG'] %>% profiling_num()


hist(mandatory_data$CIG,
  xlab = "CIG",
  main = "Ceiling histogram",
  breaks = 20,
  col = 7
)

boxplot(mandatory_data$CIG, col = 7, ylab = "CIG", main = "Ceiling boxplot")

#boxplot.stats(mandatory_data$CIG)$out

```


```{r}
#corr <- cor(mandatory_data[,3:8], use = "na.or.complete")

```


# PWO column

PWO_LABEL = case_when(
      PWO == 0 ~ "Cloud covering less then 1/2",
      PWO == 1 ~ "Cloud covering +- 1/2",
      PWO == 2 ~ "Cloud covering more then 1/2",
      PWO == 3 ~ "Sandstorm, duststorm or blowing snow",
      PWO == 4 ~ "Fog or ice fog or thick haze",
      PWO == 5 ~ "Drizzle",
      PWO == 6 ~ "Rain",
      PWO == 7 ~ "Snow, or rain and snow mixed",
      PWO == 8 ~ "Shower(s)",
      PWO == 9 ~ "Thunderstorm(s)",
      TRUE     ~ as.character(PWO)
    ),

